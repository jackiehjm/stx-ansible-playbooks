---
#
# Copyright (c) 2022-2023 Wind River Systems, Inc.
#
# SPDX-License-Identifier: Apache-2.0
#
# SUB-TASKS DESCRIPTION:
#   Setup networking so that restoring can be completed.
#   Networking should match the state it would be in after
#   completing a typical bootstrapping, so that unlocking can
#   be performed immediately after optimized restore is complete.

- name: Remove network configuration files
  file:
    path: "{{ network_scripts }}"
    state: absent

- block:
    - name: Restore network configuration files from Debian
      command: >-
        tar --use-compress-program=pigz -C / --overwrite
        -xpf {{ platform_backup_fqpn | quote }} {{ network_scripts.lstrip('/') | quote }}
      args:
        warn: false

    - name: Bring up original networking
      shell:
        cmd: |
          ifup $(ls ifcfg-* | sed 's/ifcfg-//') --ignore-errors --force
        chdir: /etc/network/interfaces.d/
      async: 60
      poll: 5

  when: previous_software_version != '21.12'

- name: Bring up temporary addresses
  block:
    - name: Lookup controller host addresses
      shell: >
        grep -E '[^\\w]({{ '|'.join(temporary_address_names) }})($|[^\\w])' /etc/hosts
        | awk '{print $1}'
        | uniq
      register: host_addresses

    - name: Check if host address is up
      shell: "ping {{ item }} -c1 -w2 | grep ' 0% packet loss'"
      failed_when: false
      loop: "{{ host_addresses.stdout_lines }}"
      register: checked_addresses

    - name: Configure missing controller host address
      command: "ip addr add {{ item.item }} dev lo scope host"
      when: item.rc != 0
      loop: "{{ checked_addresses.results }}"
