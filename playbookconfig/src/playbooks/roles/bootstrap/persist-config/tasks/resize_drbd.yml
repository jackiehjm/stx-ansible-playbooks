---
#
# Copyright (c) 2020 Wind River Systems, Inc.
#
# SPDX-License-Identifier: Apache-2.0
#
# SUB-TASKS DESCRIPTION:
#   - Resize drbd filesytems
#   - After issuing the drbdadm resize, a pause is also required prior to
#   performing the resize2fs operation.
#
#   There does not appear to be much observability into drbdadm resize
#   at /proc/drbd or drbd-overview, so a pause is introduced. The pause needed
#   to be at least 1 second as per observations in virtual and hardware labs,
#   AIO and Standard controllers.
#

- name: Resize drbd resource {{ item.resource }}
  command: "drbdadm -- --assume-peer-has-space resize {{ item.resource }}"

# Pause for 10 seconds to mimic this workaround. When moving to drbd9 this can be removed
# https://github.com/LINBIT/drbd-utils/commit/b12e02eb8ac83aeb0a2165810d91dc3f5d20c83f
- name: Pause 10 seconds for drbd resize
  pause:
    seconds: 10

- name: Resize filesystem {{ item.device }}
  command: "resize2fs /dev/{{ item.device }}"
