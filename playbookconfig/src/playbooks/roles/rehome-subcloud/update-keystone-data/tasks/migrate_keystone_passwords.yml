---
#
# Copyright (c) 2021-2022 Wind River Systems, Inc.
#
# SPDX-License-Identifier: Apache-2.0
#
# SUB-TASKS DESCRIPTION:
#   These tasks update docker registry credentials, keystone passwords in keystone
#   database, secure hieradata, relevant service config files as well as service
#   passwords in keyring.
#

- name: Prepare user list
  set_fact:
    user_list:
      - { username: 'barbican', password: "{{ users['barbican'] }}", service: 'barbican-keystone-listener' }
      # dcmanager related services are not running on the subcloud.
      - { username: 'dcmanager', password: "{{ users['dcmanager'] }}", service: 'dcmanager' }
      - { username: 'fm', password: "{{ users['fm'] }}", service: 'fm-mgr' }
      - { username: 'mtce', password: "{{ users['mtce'] }}", service: 'mtc-agent' }
      - { username: 'patching', password: "{{ users['patching'] }}", service: 'sw-patch-controller-daemon' }
      - { username: 'vim', password: "{{ users['vim'] }}", service: 'vim' }

# The hieradata must be changed before the keystone_listener is notified to apply
# the password change runtime puppet, because the puppet will use the new passwords
# in the hieradata to replace those in each service configuration file and restart
# the corresponding service.
- name: Update services' passwords in hieradata secure_static.yaml
  lineinfile:
    path: "/opt/platform/puppet/{{ software_version }}/hieradata/secure_static.yaml"
    regexp: "{{ item.From }}"
    line: "{{ item.To }}"
  loop:
    - { From: "^barbican::keystone::auth::password",
        To: "barbican::keystone::auth::password: !!python/unicode '{{ users['barbican'] }}'" }
    - { From: "^barbican::keystone::authtoken::password",
        To: "barbican::keystone::authtoken::password: !!python/unicode '{{ users['barbican'] }}'" }
    - { From: "^dcmanager::api::keystone_password",
        To: "dcmanager::api::keystone_password: !!python/unicode '{{ users['dcmanager'] }}'" }
    - { From: "^dcmanager::keystone::auth::password",
        To: "dcmanager::keystone::auth::password: !!python/unicode '{{ users['dcmanager'] }}'" }
    - { From: "^dcorch::api_proxy::dcmanager_keystone_password",
        To: "dcorch::api_proxy::dcmanager_keystone_password: !!python/unicode '{{ users['dcmanager'] }}'" }
    - { From: "^fm::auth::auth_password",
        To: "fm::auth::auth_password: !!python/unicode '{{ users['fm'] }}'" }
    - { From: "^fm::keystone::auth::password",
        To: "fm::keystone::auth::password: !!python/unicode '{{ users['fm'] }}'" }
    - { From: "^fm::keystone::authtoken::password",
        To: "fm::keystone::authtoken::password: !!python/unicode '{{ users['fm'] }}'" }
    - { From: "^nfv::keystone::auth::password",
        To: "nfv::keystone::auth::password: !!python/unicode '{{ users['vim'] }}'" }
    - { From: "^patching::api::keystone_password",
        To: "patching::api::keystone_password: !!python/unicode '{{ users['patching'] }}'" }
    - { From: "^patching::keystone::auth::password",
        To: "patching::keystone::auth::password: !!python/unicode '{{ users['patching'] }}'" }
    - { From: "^patching::keystone::authtoken::password",
        To: "patching::keystone::authtoken::password: !!python/unicode '{{ users['patching'] }}'" }
    - { From: "^platform::mtce::params::auth_pw",
        To: "platform::mtce::params::auth_pw: !!python/unicode '{{ users['mtce'] }}'" }
    - { From: "^sysinv::api::keystone_password",
        To: "sysinv::api::keystone_password: !!python/unicode '{{ users['sysinv'] }}'" }
    - { From: "^sysinv::certalarm::dc_keystone_password",
        To: "sysinv::certalarm::dc_keystone_password: !!python/unicode '{{ users['dcmanager'] }}'" }
    - { From: "^sysinv::certalarm::local_keystone_password",
        To: "sysinv::certalarm::local_keystone_password: !!python/unicode '{{ users['sysinv'] }}'" }
    - { From: "^sysinv::certmon::dc_keystone_password",
        To: "sysinv::certmon::dc_keystone_password: !!python/unicode '{{ users['dcmanager'] }}'" }
    - { From: "^sysinv::certmon::local_keystone_password",
        To: "sysinv::certmon::local_keystone_password: !!python/unicode '{{ users['sysinv'] }}'" }
    - { From: "^sysinv::keystone::auth::password",
        To: "sysinv::keystone::auth::password: !!python/unicode '{{ users['sysinv'] }}'" }
  no_log: true

- name: Update registry password in hieradata secure_system.yaml
  lineinfile:
    path: "/opt/platform/puppet/{{ software_version }}/hieradata/secure_system.yaml"
    regexp: "^platform::dockerdistribution::params::registry_password"
    line: "platform::dockerdistribution::params::registry_password: !!python/unicode '{{ users['sysinv'] }}'"
  no_log: true

- name: Update keystone user passwords
  include_tasks: update_keystone_user_password.yml
  vars:
    username: "{{ item.username }}"
    password: "{{ item.password }}"
    service: "{{ item.service }}"
  loop: "{{ user_list }}"
  no_log: true

- name: Store sysinv service password in keyring
  vars:
    script_content: |
      import keyring
      import os
      os.environ['XDG_DATA_HOME'] = "/opt/platform/.keyring/{{ software_version }}"
      keyring.set_password("sysinv", "services", "{{ users['sysinv'] }}")
  shell: "{{ script_content }}"
  args:
    executable: /usr/bin/python
  no_log: true

- name: Update sysinv password without reload sysinv conductor
  shell: >-
    source /etc/platform/openrc;
    openstack user set 'sysinv' --password $'{{ users['sysinv'] }}';

- name: Verify sysinv password was updated in sysinv service config file
  lineinfile:
    path: /etc/sysinv/sysinv.conf
    state: present
    regex: "^password=.*$"
    line: "password={{ users['sysinv'] }}"
  check_mode: true
  register: presence
  until: presence is not changed
  retries: 12
  delay: 10

# Sometimes the "Update docker registry credentials" task would fail due to
# not getting openstack secret list or service parameter list. The following
# four tasks are workarounds which are supposed to be removed in the future.
# Here's launchpad number for tracking this issue: 1992384.
- name: Verify barbican services
  shell: >-
    source /etc/platform/openrc;
    openstack secret list
  register: barbican_check_result
  ignore_errors: true
  no_log: true

- block:
  - name: Restart barbican services
    command: sm-restart service barbican-api

  - name: "Check barbican-keystone-listener service status"
    shell: sm-query service barbican-keystone-listener | grep -c enabled-active
    register: barbican_service_status
    until: barbican_service_status.stdout == '1'
    retries: 12
    delay: 10

  when: barbican_check_result.rc != 0

- name: Wait system service-parameter-list available
  shell: >-
    source /etc/platform/openrc;
    system service-parameter-list |grep docker
  register: parameter_result
  until: parameter_result.rc == 0
  retries: 12
  delay: 5

- name: Update docker registry credentials
  command: "update_docker_registry_auth.sh 'sysinv' '{{ users['sysinv'] }}'"
  no_log: true

- name: Restart sysinv conductor
  command: sm-restart service sysinv-conductor

- name: Check sysinv-conductor status
  shell: sm-query service sysinv-conductor | grep -c enabled-active
  register: sysinv_conductor_status
  until: sysinv_conductor_status.stdout == '1'
  retries: 12
  delay: 10
